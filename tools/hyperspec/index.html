<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv='X-UA-Compatible' content='IE=edge;chrome=1' />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <meta name="google-site-verification" content="qjqVOvRhHfsuDbLOvaAnj2mkUZJ9Xwzg84TMVXduvUc" />

    <meta charset="UTF-8">
    <title>Hyperloop - Tools for testing and debugging</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script src="https://unpkg.com/react@15/dist/react.min.js"></script>
    <script src="https://unpkg.com/react-dom@15/dist/react-dom.min.js"></script>

    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/0.3.5/marked.min.js"></script>


    <!-- Opal and Hyperloop -->
    <script src="http://cdn.opalrb.org/opal/current/opal.min.js"></script>
    <script src="https://rawgit.com/ruby-hyperloop/hyperloop-js/master/dist/opal.min.js"></script>
    <script src="https://rawgit.com/ruby-hyperloop/hyperloop-js/master/dist/hyperloop.min.js"></script>
    <script src="https://rawgit.com/ruby-hyperloop/hyperloop-js/master/dist/hyperloop-compiler.min.js"></script>


    <!-- If you want local copies... -->
    <!-- <script src="../../javascripts/opal-compiler.js"></script> -->
    <!-- <script src="../../javascripts/hyperloop.js"></script> -->

    <script src="https://npmcdn.com/tether@1.2.4/dist/js/tether.min.js"></script>

    <script src="../../javascripts/bootstrap.min.js"></script>
    <script src="../../javascripts/codemirror.js"></script>
    <script src="../../javascripts/ruby.js"></script>
    <script src="../../javascripts/matchbrackets.js"></script>
    <script src="../../javascripts/react_player.js"></script>
    <script src="../../javascripts/highlight.pack.js"></script>


    <!-- Components are compiled by Hyperloop Express -->
    <script type="text/ruby">

class CodeMirror < Hyperloop::Component
  param :code, type: String
  param :heading, default: "Code"
  param :rows, type: Integer, default: 0
  param :top_level_component, type: String

  before_mount do
    r=rand(2**256).to_s(36)[0..7]
    @div_code = "code_#{r}"
    @div_result = "result_#{r}"
  end

  after_mount do
  # puts params.code
    @editor = `CodeMirror(document.getElementById(#{@div_code}), {
      value: #{params.code.to_s},
      mode: 'text/x-ruby',
      matchBrackets: true,
      lineNumbers: false,
      indentUnit: 2,
      theme: 'github'
    });`

    `#{@editor}.on('change', #{lambda {on_change} })`
    `#{@editor}.setSize(null, #{@editor}.defaultTextHeight()*#{params.rows})` unless params.rows == 0
    execute_code
  end

  render(DIV) do
    div.card {
      div.card_header { params.heading }
      div(id: @div_code)
      div.card_header do
        img(src: '../../images/hyperloop-logo-small-white.png' , width:'25')
        span { ' ' }
        'Live editor results'
      end
      div.card_block(id: @div_result)
    }
  end

  def on_change
    execute_code
  end

  def execute_code
    begin
      code = `#{@editor}.getValue()`
      # puts code
      code += "\nElement['##{@div_result}'].render(#{params.top_level_component})"
      compiled_code = Opal::Compiler.new(code).compile

      `ReactDOM.unmountComponentAtNode(document.getElementById(#{@div_result}));`

      # Dispatchers and Receivers example works but Steps example breaks
      # Hyperloop::Context.reset!
      # `eval(#{compiled_code})`
      # Hyperloop::Application::Boot.run()

      # Steps example works but Dispatchers and Receivers example breaks
      `eval(#{compiled_code})`
      Hyperloop::Context.reset!
      Hyperloop::Application::Boot.run()

      component = Module.const_get params.top_level_component
      # we need to see if the component is valid - try checking if it can render static markup
      # the following line generates: `undefined method to_n for SimpleComponent`
      # if React.render_to_static_markup( component ).empty?
      #   invalid_component_message
      # end
    rescue Exception => e
      @time_out = after(0.1) do
        unable_to_compile_message e.message
      end
    end
  end

  def invalid_component_message
    message = div.text_danger do
      h3.text_danger {"Oops, invalid Component..."}
      p { "Your Component has been rejected by React. A valid Component must have a render macro and return just one HTML element." }
    end
    Element["##{@div_result}"].render{ message }
  end

  def unable_to_compile_message reason
    message = div.text_danger do
      h3.text_danger {"Can't compile..."}
      p { reason }
    end
    Element["##{@div_result}"].render{ message }
  end

end

</script>

    <script type="text/ruby">

Document.ready? do
   Element.find('div.codemirror-live-edit').each do |mount_point|
     heading = mount_point.attr('data-heading')
     rows = mount_point.attr('data-rows')
     top_level_component = mount_point.attr('data-top-level-component')
     code = Element[mount_point].find('pre').text.strip
     params = {code: code, top_level_component: top_level_component}
     params = params.merge({heading: heading}) if heading
     params = params.merge({rows: rows.to_i}) if rows
     codemirror_component = Object.const_get('CodeMirror')
     React.render(React.create_element(codemirror_component, params ), mount_point)
   end
end

</script>


    <script type="text/ruby">

class ToggleCodemirror < Hyperloop::Component
  param :code, type: String
  param :heading, default: "Code"
  param :rows, type: Integer, default: 0
  param :top_level_component, type: String
  param :show_code

  before_mount do
    r=rand(2**256).to_s(36)[0..7]
    @div_code = "code_#{r}"
    @div_result = "result_#{r}"
  end

  after_mount do
  # puts params.code
    @editor = `CodeMirror(document.getElementById(#{@div_code}), {
      value: #{params.code.to_s},
      mode: 'text/x-ruby',
      matchBrackets: true,
      lineNumbers: false,
      indentUnit: 2,
      readOnly: true,
      theme: 'github'
    });`

    `#{@editor}.setSize(null, #{@editor}.defaultTextHeight()*#{params.rows})` unless params.rows == 0

    Element['.codediv'].hide('')
    mutate.show_code false
    
  end

  render(DIV) do
    div.card {
      div.card_header do
        div(class: 'row') do
          div(class: 'col-md-6') do
            img(src: '../../images/hyperloop-logo-small-white.png' , width:'25') 
            span { ' ' }
            span { params.heading }
          end
          div(class: 'col-md-6 align-right') do

            toggle_link
          end
        end
      end

      div(id: @div_code, class: 'codediv') 
    }
  end

  def toggle_link
    
      BUTTON(class: 'btn btn-info btn-sm') do
        state.show_code ? "Click to hide code" : "Click to show code"
      end.on(:click) do |ev|
        mutate.show_code !state.show_code 
        state.show_code ? Element["##{@div_code}"].show('') : Element["##{@div_code}"].hide('')
      end
    
  end

 
end

</script>

    <script type="text/ruby">

Document.ready? do
    Element.find('div.togglecode').each do |mount_point|
        heading = mount_point.attr('data-heading')
        rows = mount_point.attr('data-rows')
        top_level_component = mount_point.attr('data-top-level-component')
        code = Element[mount_point].find('pre').text.strip
        params = {code: code, top_level_component: top_level_component}
        params = params.merge({heading: heading}) if heading
        params = params.merge({rows: rows.to_i}) if rows
        codemirror_component = Object.const_get('ToggleCodemirror')
        React.render(React.create_element(codemirror_component, params ), mount_point)
    end
end

</script>

    <link href="../../stylesheets/bootstrap.min.css" rel="stylesheet" />
    <link href="../../stylesheets/typography.css" rel="stylesheet" />
    <link href="../../stylesheets/override.css" rel="stylesheet" />
    <link href="../../stylesheets/divtable.css" rel="stylesheet" />
    <!-- <link href="../../stylesheets/code.css" rel="stylesheet" /> -->
    <link href="../../stylesheets/github.css" rel="stylesheet" />
    <link href="../../stylesheets/highlighting.css" rel="stylesheet" />
    <link href="../../stylesheets/codemirror.css" rel="stylesheet" />
    <link href="../../stylesheets/monokai-sublime.css" rel="stylesheet" />

    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />

    <!-- Favicons -->

    <link rel="apple-touch-icon" sizes="180x180" href="../../images/apple-touch-icon.png">
    <link rel="icon" type="image/png" href="../../images/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="../../images/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="/images/manifest.json">
    <link rel="mask-icon" href="../../images/safari-pinned-tab.svg" color="#e81176">
    <meta name="theme-color" content="#ffffff">

  </head>

  <body>
    <div class="navbarbackgroundcolor">
      <div class="container">
        <nav class="navbar navbar-ligh">
  <button class="navbar-toggler hidden-sm-up" type="button" data-toggle="collapse" data-target="#exCollapsingNavbar2" aria-controls="exCollapsingNavbar2" aria-expanded="false" aria-label="Toggle navigation">
    &#9776;
  </button>
  <div class="collapse navbar-toggleable-xs" id="exCollapsingNavbar2">
    <ul class="nav navbar-nav">
      <li class="nav-item">
        <a href="/" class="nav-link"><span class='navfirstletter'>H</span>yperloop</a>
      </li>
      <li class="nav-item">
        <a href="/start/components" class="nav-link active"><span class='navfirstletter'>S</span>tart</a>
      </li>
      <li class="nav-item">
        <a href="/installation" class="nav-link"><span class='navfirstletter'>I</span>nstallation</a>
      </li>
      <li class="nav-item">
        <a href="/tutorials" class="nav-link"><span class='navfirstletter'>T</span>utorials</a>
      </li>
      <li class="nav-item">
        <a href="/gems" class="nav-link"><span class='navfirstletter'>G</span>ems</a>
      </li>
      <li class="nav-item">
        <a href="https://github.com/ruby-hyperloop" class="nav-link"><span class='navfirstletter'>G</span>ithub</a>
      </li>
      <li class="nav-item">
        <a href="/tools" class="nav-link"><span class='navfirstletter'>T</span>ools</a>
      </li>
      <li class="nav-item">
        <a href="/docs/architecture" class="nav-link"><span class='navfirstletter'>D</span>ocs</a>
      </li>
      <li class="nav-item">
        <a href="/help" class="nav-link"><span class='navfirstletter'>H</span>elp</a>
      </li>
      <li class="nav-item">
        <a href="/blog" class="nav-link"><span class='navfirstletter'>B</span>log</a>
      </li>
      <!-- <li class="nav-item">
        <input type="text" name="search" />
      </li> -->
    </ul>
  </div>
</nav>

      </div>
    </div>





    <div class="jumbotron page-header">
      <div class="container">

        <div class="row hidden-sm-down">
          <div class="col-md-2">
            <div class="hyperlooplogo">
            </div>
          </div>
          <div class="col-md-8">

            <h1 class="display-4 project-name">Hyperloop</h1>

            <h4 class="display-7 project-tagline">

              Tools for testing and debugging
            </h4>
          </div>

        </div>

        <div class="row hidden-md-up">
          <div class="col-md-3">
            <div class="hyperlooplogo">
            </div>
          </div>
          <div class="col-md-9">
            <h1 class="h1 project-name center-text">Hyperloop</h1>
            </br>
            <h2 class="h5 project-tagline center-text">
              Tools for testing and debugging
            </h2>
          </div>

        </div>


      </div>
    </div>

    <div class="page-header-underline">
      <div class="container">

      </div>
    </div>

    <div class="container">
      <div class="row">
        <div class="col-md-3 sidenavcol">
            <ul class="nav">
    <li class="nav-item"><a href="/tools#hyper-console">Hyper-console</a></br></li>
    <li class="nav-item"><a href="/tools#hyper-spec">Hyper-spec</a></br></li>
    <li class="nav-item"><a href="/tools#hyper-trace">Hyper-trace</a></br></li>
    <li class="nav-item"><a href="/tools#opalhotreloader">Opal Hot Reloader</a></br></li>
    <li class="nav-item"><a href="/tools#debuggingtips">Debugging tips</a></br></li>
  </ul>


  <div class="getstarted">
    <br>
    <hr>
    <p>NEWS: RubyHyperloop is to be renamed Hyperstack. Come and see the work-in-progress site: </p>
    <!-- <button type="button" class="btn btn-primary btn-lg btn-hyperlooppink" onclick="https://hyperstack.org';">https://hyperstack.org</button> -->
    <a href='https://hyperstack.org'>https://hyperstack.org</a>
  </div>

          <br>
        </div>
        <div class="col-md-9 main-content">
          <h1><div class="hyperlogoalone" id="components"><img src="../../images/HyperSpecs.png" width="50" alt="Hyperspecs" /></div>
<div class="chaptertitle"><span class="bigfirstletter">H</span>yper-spec documentation</div>
</h1>

<p>With HyperSpec you can run <em>isomorphic</em> specs for all your Hyperloop code using RSpec.  Everything runs as standard RSpec test specs.  </p>

<p>For example if you have a component like this:</p>
<pre class="highlight ruby"><code><span class="k">class</span> <span class="nc">SayHello</span> <span class="o">&lt;</span> <span class="no">React</span><span class="o">::</span><span class="no">Component</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">param</span> <span class="ss">:name</span>
  <span class="n">render</span><span class="p">(</span><span class="no">DIV</span><span class="p">)</span> <span class="k">do</span>
    <span class="s2">"Hello there </span><span class="si">#{</span><span class="n">params</span><span class="p">.</span><span class="nf">name</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<p>Your test spec would look like this:</p>
<pre class="highlight ruby"><code><span class="n">describe</span> <span class="s1">'SayHello'</span><span class="p">,</span> <span class="ss">js: </span><span class="kp">true</span> <span class="k">do</span>
  <span class="n">it</span> <span class="s1">'has the correct content'</span> <span class="k">do</span>
    <span class="n">mount</span> <span class="s2">"SayHello"</span><span class="p">,</span> <span class="ss">name: </span><span class="s1">'Fred'</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'Hello there Fred'</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<p>The <code>mount</code> method will setup a blank client window, and <em>mount</em> the named component in the window, passing any parameters.</p>

<p>Notice that the spec will need a client environment so we must set <code>js: true</code>.</p>

<p>The <code>mount</code> method can also take a block which will be recompiled and set to the client before mounting the component.  You can place any client side code in the mount block including the definition of components.</p>
<pre class="highlight ruby"><code><span class="n">describe</span> <span class="s2">"the mount's code block"</span><span class="p">,</span> <span class="ss">js: </span><span class="kp">true</span> <span class="k">do</span>
  <span class="n">it</span> <span class="s1">'will be recompiled on the client'</span> <span class="k">do</span>
    <span class="n">mount</span> <span class="s1">'ShowOff'</span> <span class="k">do</span>
      <span class="k">class</span> <span class="nc">ShowOff</span> <span class="o">&lt;</span> <span class="no">React</span><span class="o">::</span><span class="no">Component</span><span class="o">::</span><span class="no">Base</span>
        <span class="n">render</span><span class="p">(</span><span class="no">DIV</span><span class="p">)</span> <span class="p">{</span> <span class="s1">'Now how cool is that???'</span> <span class="p">}</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'Now how cool is that???'</span> <span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<h2 id="why">Why?</h2>

<p>Hyperloop wants to make the server-client divide as transparent to the developer as practical.  Given this, it makes sense that the testing should also be done with as little concern for client versus server.  </p>

<p>HyperSpec allows you to directly use tools like FactoryGirl (or Hyperloop Operations) to setup some test data, then run a spec to make sure that a component correctly displays, or modifies that data.  You can use Timecop to manipulate time and keep in sync between the server and client.  This makes testing easier and more realistic without writing a lot of redundant code.</p>

<h2 id="installation">Installation</h2>

<p>Add this line to your application&#39;s Gemfile in the test section:</p>
<pre class="highlight ruby"><code><span class="n">gem</span> <span class="s1">'hyper-spec'</span>
</code></pre>
<p>Execute:</p>
<pre class="highlight plaintext"><code>$ bundle install
</code></pre>
<p>and then in your spec_helper.rb file</p>
<pre class="highlight ruby"><code><span class="nb">require</span> <span class="s1">'hyper-spec'</span>
</code></pre>
<p>You will also need to install selenium, poltergeist and firefox version <strong>46.0.1</strong> (ff latest still does not play well with selenium).</p>

<p>Sadly at this time the selenium chrome driver does not play nicely with Opal, so you can&#39;t use Chrome.  We are working on getting rid of the whole selenium business.  Stay tuned.</p>

<h2 id="environment-variables">Environment Variables</h2>

<p>You can set <code>DRIVER</code> to <code>ff</code> to run the client in Firefox and see what is going on.  By default tests will run in poltergeist which is quicker, but harder to debug problems.</p>
<pre class="highlight plaintext"><code>DRIVER=ff bundle exec rspec
</code></pre>
<h2 id="spec-helpers">Spec Helpers</h2>

<p>HyperSpec adds the following spec helpers to your test environment</p>

<ul>
<li><code>mount</code></li>
<li><code>client_option</code> and <code>client_options</code></li>
<li><code>on_client</code></li>
<li><code>isomorphic</code></li>
<li><code>evaluate_ruby</code></li>
<li><code>expect_evaluate_ruby</code></li>
<li><code>expect_promise</code></li>
<li>call back and event history methods</li>
<li><code>pause</code></li>
<li><code>attributes_on_client</code></li>
<li><code>size_window</code></li>
<li><code>add_class</code></li>
</ul>

<h4 id="the-mount-method">The <code>mount</code> Method</h4>

<p><code>mount</code> takes the name of a component, prepares an empty test window, and mounts the named component in the window.<br>
You may give a block to <code>mount</code> which will be recompiled on the client, and run <em>before</em> mounting.  This means that the component
mounted may be actually defined in the block, which is useful for setting up top level wrapper components, which will invoke your component under test.  You can also modify existing components for white box testing, or local fixture data, constants, etc.</p>

<p><code>mount</code> may also be given a hash of the parameters to be passed to the component.</p>
<pre class="highlight ruby"><code><span class="n">mount</span> <span class="s1">'Display'</span><span class="p">,</span> <span class="ss">test: </span><span class="mi">123</span> <span class="k">do</span>
  <span class="k">class</span> <span class="nc">Display</span> <span class="o">&lt;</span> <span class="no">React</span><span class="o">::</span><span class="no">Component</span><span class="o">::</span><span class="no">Base</span>
    <span class="n">param</span> <span class="ss">:test</span>
    <span class="n">render</span><span class="p">(</span><span class="no">DIV</span><span class="p">)</span> <span class="p">{</span> <span class="n">params</span><span class="p">.</span><span class="nf">test</span><span class="p">.</span><span class="nf">to_s</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<h4 id="the-client_option-method">The <code>client_option</code> Method</h4>

<p>There are several options that control the mounting process.  Use <code>client_option</code> (or <code>client_options</code>) before accessing any client side to set any of these options:</p>

<ul>
<li><code>render_on</code>: <code>:server_only</code>, <code>:client_only</code>, or <code>:both</code>, default is client_only.</li>
<li><code>layout</code>: specify the layout to be used.  Default is :none.</li>
<li><code>style_sheet</code>: specify the name of the style sheet to be loaded. Defaults to the application stylesheet.</li>
<li><code>javascript</code>: specify the name of the javascript asset file to be loaded. Defaults to the application js file.</li>
</ul>

<p>For example:</p>
<pre class="highlight ruby"><code><span class="n">it</span> <span class="s2">"can be rendered server side only"</span> <span class="k">do</span>
  <span class="n">client_option</span> <span class="ss">render_on: :server_only</span>
  <span class="n">mount</span> <span class="s1">'SayHello'</span><span class="p">,</span> <span class="ss">name: </span><span class="s1">'George'</span>
  <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_content</span><span class="p">(</span><span class="s1">'Hello there George'</span><span class="p">)</span>
  <span class="c1"># Server only means no code is downloaded to the client</span>
  <span class="n">expect</span><span class="p">(</span><span class="n">evaluate_script</span><span class="p">(</span><span class="s1">'typeof React'</span><span class="p">)).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s1">'undefined'</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
<p>If you need to pull in alternative style sheets and javascript files, the recommended way to do this is to</p>

<ol>
<li>Add them to a <code>specs/assets/stylesheets</code> and <code>specs/assets/javascripts</code> directory and</li>
<li>Add the following line to your <code>config/environment/test.rb</code> file:<br>
<code>ruby
config.assets.paths &lt;&lt; ::Rails.root.join(&#39;spec&#39;, &#39;assets&#39;, &#39;stylesheets&#39;).to_s
config.assets.paths &lt;&lt; ::Rails.root.join(&#39;spec&#39;, &#39;assets&#39;, &#39;javascripts&#39;).to_s
</code></li>
</ol>

<p>This way you will not pollute your application with these &#39;test only&#39; files.</p>

<p><em>The javascript spec asset files can be <code>.rb</code> files and contain ruby code as well.  See the specs for examples!</em></p>

<h4 id="the-on_client-method">The <code>on_client</code> Method</h4>

<p><code>on_client</code> takes a block and compiles and runs it on the client.  This is useful in setting up test constants and client only fixtures.</p>

<p>Note that <code>on_client</code> needs to <em>proceed</em> any calls to <code>mount</code>, <code>evaluate_ruby</code>, <code>expect_evaluate_ruby</code> or <code>expect_promise</code> as these methods will initiate the client load process.</p>

<h4 id="the-isomorphic-method">The <code>isomorphic</code> Method</h4>

<p>Similar to <code>on_client</code> but the block is <em>also</em> run on the server.  This is useful for setting constants shared by both client and server, and modifying behavior of isomorphic classes such as ActiveRecord models, and HyperOperations.</p>
<pre class="highlight ruby"><code><span class="n">isomorphic</span> <span class="k">do</span>
  <span class="k">class</span> <span class="nc">SomeModel</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
    <span class="k">def</span> <span class="nf">fake_attribute</span>
      <span class="mi">12</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
<h4 id="the-evaluate_ruby-method">The <code>evaluate_ruby</code> Method</h4>

<p>Takes either a string or a block, dynamically compiles it, downloads it to the client and runs it.</p>
<pre class="highlight ruby"><code><span class="n">evaluate_ruby</span> <span class="k">do</span>
  <span class="n">i</span> <span class="o">=</span> <span class="mi">12</span>
  <span class="n">i</span> <span class="o">*</span> <span class="mi">2</span>
<span class="k">end</span>
<span class="c1"># returns 24</span>

<span class="n">isomorphic</span> <span class="k">do</span>
  <span class="k">def</span> <span class="nf">factorial</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">?</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">n</span> <span class="o">*</span> <span class="n">factorial</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">expect</span><span class="p">(</span><span class="n">evaluate_ruby</span><span class="p">(</span><span class="s2">"factorial(5)"</span><span class="p">)).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="n">factorial</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
</code></pre>
<p><code>evaluate_ruby</code> can also be very useful for debug.  Set a breakpoint in your test, then use <code>evaluate_ruby</code> to interrogate the state of the client.</p>

<h4 id="the-expect_evaluate_ruby-method">The <code>expect_evaluate_ruby</code> Method</h4>

<p>Combines expect and evaluate methods:</p>
<pre class="highlight ruby"><code><span class="n">expect_evaluate_ruby</span> <span class="k">do</span>
  <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="mi">5</span><span class="p">.</span><span class="nf">times</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">*</span><span class="n">n</span> <span class="p">}</span>
  <span class="n">i</span>
<span class="k">end</span><span class="p">.</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">120</span><span class="p">)</span>
</code></pre>
<h4 id="the-expect_promise-method">The <code>expect_promise</code> Method</h4>

<p>Works like <code>expect_evaluate_ruby</code> but is used with promises.  <code>expect_promise</code> will hang until the promise resolves and then return to the results.</p>
<pre class="highlight ruby"><code><span class="n">expect_promise</span> <span class="k">do</span>
  <span class="no">Promise</span><span class="p">.</span><span class="nf">new</span><span class="p">.</span><span class="nf">tap</span> <span class="k">do</span> <span class="o">|</span><span class="nb">p</span><span class="o">|</span>
    <span class="n">after</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span> <span class="nb">p</span><span class="p">.</span><span class="nf">resolve</span><span class="p">(</span><span class="s1">'hello'</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span><span class="p">.</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s1">'hello'</span><span class="p">)</span>
</code></pre>
<h4 id="call-back-and-event-history-methods">Call Back and Event History Methods</h4>

<p>HyperReact components can <em>generate</em> events and perform callbacks.  HyperSpec provides methods to test if an event or callback was made.</p>
<pre class="highlight ruby"><code><span class="n">mount</span> <span class="s1">'CallBackOnEveryThirdClick'</span> <span class="k">do</span>
  <span class="k">class</span> <span class="nc">CallBackOnEveryThirdClick</span> <span class="o">&lt;</span> <span class="no">React</span><span class="o">::</span><span class="no">Component</span><span class="o">::</span><span class="no">Base</span>
    <span class="n">param</span> <span class="ss">:click3</span><span class="p">,</span> <span class="ss">type: </span><span class="no">Proc</span>
    <span class="k">def</span> <span class="nf">increment_click</span>
      <span class="vi">@clicks</span> <span class="o">||=</span> <span class="mi">0</span>
      <span class="vi">@clicks</span> <span class="o">=</span> <span class="p">(</span><span class="vi">@clicks</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
      <span class="n">params</span><span class="p">.</span><span class="nf">click3</span><span class="p">(</span><span class="vi">@clicks</span><span class="p">)</span> <span class="k">if</span> <span class="vi">@clicks</span> <span class="o">%</span> <span class="mi">3</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">end</span>
    <span class="n">render</span> <span class="k">do</span>
      <span class="no">DIV</span><span class="p">(</span><span class="ss">class: :tp_clicker</span><span class="p">)</span> <span class="p">{</span> <span class="s2">"click me"</span> <span class="p">}</span>
      <span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="ss">:click</span><span class="p">)</span> <span class="p">{</span> <span class="n">increment_click</span> <span class="p">}</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="mi">7</span><span class="p">.</span><span class="nf">times</span> <span class="p">{</span> <span class="n">page</span><span class="p">.</span><span class="nf">click</span><span class="p">(</span><span class="s1">'#tp_clicker'</span><span class="p">)</span> <span class="p">}</span>
<span class="n">expect</span><span class="p">(</span><span class="n">callback_history_for</span><span class="p">(</span><span class="ss">:click3</span><span class="p">)).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">([[</span><span class="mi">3</span><span class="p">],</span> <span class="p">[</span><span class="mi">6</span><span class="p">]])</span>
</code></pre>
<p>Note that for things to work, the param must be declared as a <code>type: Proc</code>.</p>

<ul>
<li><code>callback_history_for</code>: the entire history given as an array of arrays</li>
<li><code>last_callback_for</code>: same as <code>callback_history_for(xxx).last</code></li>
<li><code>clear_callback_history_for</code>: clears the array (userful for repeating test variations without remounting)</li>
<li><code>event_history_for, last_event_for, clear_event_history_for</code>: same but for events.</li>
</ul>

<h4 id="the-pause-method">The <code>pause</code> Method</h4>

<p>For debugging.  Everything stops, until you type <code>go()</code> in the client console.  Running binding.pry also has this effect, and is often sufficient, however it will also block the server from responding unless you have a multithreaded server.</p>

<h4 id="the-attributes_on_client-method">The <code>attributes_on_client</code> Method</h4>

<p><em>This feature is currently untested - use at your own risk.</em></p>

<p>This reads the value of active record model attributes on the client.</p>

<p>In other words the method <code>attributes_on_client</code> is added to all ActiveRecord models.   You then take a model you have instance of on the server, and by passing the Capybara page object, you get back the attributes for that same model instance, currently on the client.</p>
<pre class="highlight ruby"><code><span class="n">expect</span><span class="p">(</span><span class="n">some_record_on_server</span><span class="p">.</span><span class="nf">attributes_on_client</span><span class="p">(</span><span class="n">page</span><span class="p">)[</span><span class="ss">:fred</span><span class="p">]).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
</code></pre>
<p>Note that after persisting a record the client and server will be synced so this is mainly useful for debug or in rare cases where it is important to interrogate the value on the client before its persisted.</p>

<h4 id="the-size_window-method">The <code>size_window</code> Method</h4>

<p>Sets the size of the test window.  You can say:
<code>size_window(width, height)</code> or pass one of the following standard sizes:  to one of the following standard sizes:</p>

<ul>
<li>small: 480 X 320</li>
<li>mobile: 640 X 480</li>
<li>tablet: 960 X 640</li>
<li>large: 1920 X 6000</li>
<li>default: 1024 X 768</li>
</ul>

<p>example: <code>size_window(:mobile)</code></p>

<p>You can also modify the standard sizes with <code>:portrait</code></p>

<p>example: <code>size_window(:table, :portrait)</code></p>

<p>You can also specify the size by providing the width and height.</p>

<p>example: <code>size_window(600, 600)</code></p>

<p>size<em>window with no parameters is the same as `size</em>window(:default)`</p>

<p>Typically you will use this in a <code>before(:each)</code> or <code>before(:step)</code> block</p>

<h4 id="the-add_class-method">The <code>add_class</code> Method</h4>

<p>Sometimes it&#39;s useful to change styles during testing (mainly for debug so that changes on screen are visible.)</p>

<p>The <code>add_class</code> method takes a class name (as a symbol or string), and hash representing the style.</p>
<pre class="highlight ruby"><code><span class="n">it</span> <span class="s2">"can add classes during testing"</span> <span class="k">do</span>
  <span class="n">add_class</span> <span class="ss">:some_class</span><span class="p">,</span> <span class="ss">borderStyle: :solid</span>
  <span class="n">mount</span> <span class="s1">'StyledDiv'</span> <span class="k">do</span>
    <span class="k">class</span> <span class="nc">StyledDiv</span> <span class="o">&lt;</span> <span class="no">React</span><span class="o">::</span><span class="no">Component</span><span class="o">::</span><span class="no">Base</span>
      <span class="n">render</span><span class="p">(</span><span class="no">DIV</span><span class="p">,</span> <span class="ss">id: </span><span class="s1">'hello'</span><span class="p">,</span> <span class="ss">class: </span><span class="s1">'some_class'</span><span class="p">)</span> <span class="k">do</span>
        <span class="s1">'Hello!'</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="n">expect</span><span class="p">(</span><span class="n">page</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="s1">'#hello'</span><span class="p">).</span><span class="nf">native</span><span class="p">.</span><span class="nf">css_value</span><span class="p">(</span><span class="s1">'border-right-style'</span><span class="p">)).</span><span class="nf">to</span> <span class="n">eq</span><span class="p">(</span><span class="s1">'solid'</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
<h2 id="integration-with-the-steps-gem">Integration with the Steps gem</h2>

<p>The <a href="https://github.com/LRDesign/rspec-steps">rspec-steps gem</a> can be useful in doing client side testing.  Without rspec-steps, each test spec will cause a reload of the browser window.  While this insures that each test runs in a clean environment, it is typically not necessary and can really slow down testing.</p>

<p>The rspec-steps gem will run each test without reloading the window, which is usually fine.</p>

<p>Checkout the rspec-steps example in the <code>hyper_spec.rb</code> file for an example.</p>

<p><em>Note that hopefully in the near future we are going to build a custom capybara driver that will just directly talk to Hyperloop on the client side.  Once this is in place these troubles should go away! - Volunteers welcome to help!</em></p>

<h2 id="timecop-integration">Timecop Integration</h2>

<p>HyperSpec is integrated with <a href="https://github.com/travisjeffery/timecop">Timecop</a> to freeze, move and speed up time.  The client and server times will be kept in sync when you use any these Timecop methods:</p>

<ul>
<li><code>freeze</code>:  Freezes time at the specified point in time (default is Time.now)</li>
<li><code>travel</code>:  Time runs normally forward from the point specified.</li>
<li><code>scale</code>:   Like travel but times runs faster.</li>
<li><code>return</code>:  Return to normal system time.</li>
</ul>

<p>For example:
```ruby
Timecop.freeze # freeze time at current time</p>

<h1 id="test-some-stuff">... test some stuff</h1>

<p>Timecop.freeze Time.now+10.minutes # move time forward 10 minutes</p>

<h1 id="check-to-see-if-expected-events-happened-etc">... check to see if expected events happened etc</h1>

<p>Timecop.return
```</p>
<pre class="highlight ruby"><code><span class="no">Timecop</span><span class="p">.</span><span class="nf">scale</span> <span class="mi">60</span><span class="p">,</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="o">-</span><span class="mi">1</span><span class="p">.</span><span class="nf">year</span> <span class="k">do</span>
  <span class="c1"># Time will begin 1 year ago but advance 60 times faster than normal</span>
  <span class="nb">sleep</span> <span class="mi">10</span>
  <span class="c1"># still sleeps for 10 seconds YOUR time, but server and client will</span>
  <span class="c1"># think 10 minutes have passed</span>
<span class="k">end</span>
<span class="c1"># no need for Timecop.return if using the block style</span>
</code></pre>
<p>See the Timecop <a href="https://github.com/travisjeffery/timecop/blob/master/README.markdown">README</a> for more details.</p>

<p>There is one confusing thing to note:  On the server if you <code>sleep</code> then you will sleep for the specified number of seconds when viewed <em>outside</em> of the test.  However inside the test environment if you look at Time.now, you will see it advancing according to the scale factor.  Likewise if you have a <code>after</code> or <code>every</code> block on the client, you will wait according to <em>simulated</em> time.</p>

<h2 id="common-problems">Common Problems</h2>

<p>If you are getting failures on Poltergeist but not Firefox, make sure you are not requiring <code>browser</code> in your components.rb.
Requiring <code>browser/interval</code> or <code>browser/delay</code> is okay.</p>

        </div>
      </div>
    </div>

    <div class="page-footer-upperline">
      <div class="container">

      </div>
    </div>

    <footer class="nav-footer">
  <section class="sitemap">

    <a href="/" class="nav-home"></a>

    <div>
      <h6><a href="/start/components" class="hyperloop-white">Start</a></h6>
      <a href="/start/components">Components</a>
      <a href="/start/stores">Stores</a>
      <a href="/start/models">Models</a>
      <a href="/start/operations">Operations</a>
      <a href="/start/policies">Policies</a>
      <a href="/start/pragmatic">Pragmatic Thinking</a>
    </div>
    <div>


      <h6><a href="/tutorials" class="hyperloop-white">Tutorials</a></h6>
      <a href="/tutorials/hyperloopcomps">Hyperloop COMPS</a>
      <a href="/tutorials/hyperloopjs">Hyperloop.js</a>
      <a href="/tutorials/hyperlooprails">Hyperloop and Rails</a>
      <a href="/tutorials/hyperloopdeploy">Hyperloop deployment</a>
      <a href="/tutorials/opal">Opal</a>
      <a href="/tutorials/videos">Videos</a>
    </div>
    <div>
      <h6><a href="/installation" class="hyperloop-white">Installation</a></h6>
      <a href="/installation#opal-playground">Hyperloop.js</a>
  	  <a href="/installation#ror">With Ruby On Rails</a>
  	  <a href="/installation#with-sinatra">With Sinatra</a>
  	  <a href="/installation#deployment">Deployment</a>
    </div>
    <div>
      <h6><a href="/gems" class="hyperloop-white">Gems</a></h6>
      <a href="https://github.com/ruby-hyperloop/hyperloop">hyperloop</a>
      <a href="https://github.com/ruby-hyperloop/hyperloop-js">hyperloop-js</a>
      <a href="https://github.com/ruby-hyperloop/hyper-react">hyper-component</a>
      <a href="https://github.com/ruby-hyperloop/hyper-store">hyper-store</a>
      <a href="https://github.com/ruby-hyperloop/hyper-mesh">hyper-model</a>
      <a href="https://github.com/ruby-hyperloop/hyper-operation">hyper-operation</a>
      <a href="https://github.com/ruby-hyperloop/reactrb-router/tree/v2-4-0">hyper-router</a>
      <a href="https://github.com/ruby-hyperloop/hyper-spec">hyper-spec</a>
      <a href="https://github.com/ruby-hyperloop/hyper-trace">hyper-trace</a>
    </div>
    <div>
      <h6><a href="/tools" class="hyperloop-white">Tools</a></h6>
      <a href="#testing">Testing</a>
    	<a href="#tools">Tools</a>
    	<a href="#debugging">Debugging</a>
    </div>
    <div>
      <h6><a href="/docs/architecture" class="hyperloop-white">Docs</a></h6>
      <a href="/docs/architecture">Architecture</a>
      <a href="/docs/components/docs#components-dsl-overview">Components</a>
      <a href="/docs/stores/docs">Stores</a>
      <a href="/docs/models/docs">Models</a>
      <a href="/docs/operations/docs">Operations</a>
      <a href="/docs/policies/docs">Policies</a>
    </div>

  </section>

  <section class="otherlinks">
    <a href="https://github.com/ruby-hyperloop" class="hyperloop-white">Github</a>
    <a href="/support" class="hyperloop-white">Help</a>
    <a href="/blog" class="hyperloop-white">Blog</a>
  </section>

  <section class="copyright">
    Copyright © 2018 Hyperloop.
  </section>
</footer>


    <script>
      (function(Opal) {
        var self = Opal.top, $scope = Opal, nil = Opal.nil, $breaker = Opal.breaker, $slice = Opal.slice;
        Opal.add_stubs(['$puts']);
        return self.$puts("Opal ok")
      })(Opal);
    </script>

    <!-- <script   src="http://code.jquery.com/jquery-3.1.1.min.js"   integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="   crossorigin="anonymous"></script> -->


    <script type="text/ruby">puts "Hyperloop JS ok"</script>




  </body>
</html>
